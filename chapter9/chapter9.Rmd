---
title: "第九章 双变量回归与相关"
author: "x2yline"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: vignette
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev='CairoPNG')
```

## 知识清单  
1. 直线回归
    - 相关概念
    - 求法
    - 统计推断
    - 区间估计
2. 直线相关
    - 相关概念
    - 求法
    - 统计推断
    - 决定系数
3. **直线回归应用注意事项**
4. 秩相关
5. *两回归直线的比较*
6. *曲线拟合*

## 1. 直线回归
### 1.1 基本概念
* 用途
    - 不是前几章的单变量，而是两个变量的关系
    - 数值变量或有序分类变量（秩相关）
* 直线方程及各值含义
    - 方程 1  
    \[
      \hat{y}=a=bX
    \]
    - 方程 2
    \[
      \mu_{Y|X}=\alpha+\beta X
    \]
        - $\hat{y}$表示X对应Y的总体均数$\mu_{Y|X}$的一个样本估计，称预测值
        - a、b分别为$\alpha$和$\beta$的样本估计，a称为常数项，b称**回归系数**
        - b的统计意义是当X变化一个单位时Y的平均改变的估计值
        
### 1.2 计算方法

#### 1.2.1 理论计算
根据实测值Y与假定回归直线上的估计值$\hat{y}$的纵向距离$Y-\hat{y}$（残差）的平方和最小即最小二乘法可以推出
\[
  b=\frac{l_{XY}}{l_{XX}}=\frac{\sum{}{}(X-\bar{X})(Y-\bar{Y})}{\sum{}{}(X-\bar{X})^{2})}
\]

\[
  a=\bar{Y}-b\bar{X}
\]
式中$l_{XY}$为X与Y的离均差交叉乘积和，简称离均差积和

#### 1.2.2 R语言计算
```{r}
data9_1 <- haven::read_sav(
  file="E:\\医学统计学（第4版）\\各章例题SPSS数据文件\\例09-01.sav")
colnames(data9_1) <- c("age", "conc")
head(data9_1)

line.model <- lm(conc~age, data=data9_1)
print(line.model)
line.model_summary <- summary(line.model)
```

### 1.3 统计推断
H0：$\beta=0$，即两变量直接无直线关系  
H1：$\beta \neq 0$，即两变量之间有线性关系  

#### 1.3.1 方差分析

##### 公式
把Y的离均差平方和进行分解，分为回归平方和与残差平方和，其自由度分别为1，n-2。
\[
  Y-\bar{Y}=Y-\hat{Y}+\hat{Y}-\bar{Y}
\]
\[
  \sum{}{}(Y-\bar{Y})^{2}=\sum{}{}(\hat{y}-\bar{Y})^{2} + \sum{}{}(Y-\hat{y})^{2}
\]
\[
  SS_{总}=SS_{回}+SS_{残}
\]

F值计算公式为（单侧F检验）：

\[
F=\frac{SS_{回}/\nu_{回}}{SS_{残}/\nu_{残}},\ \nu_{回}=1,\ \nu_{残}=n-2
\]

$SS_{回}$计算公式可以化简为：

\[
  SS_{回}=bl_{XY}=\frac{l_{XY}^{2}}{l_{XX}}=b^{2}l_{XX}
\]

##### R语言实现
* 手动计算
```{r}
# 残差平方和
ss2 <- sum(line.model$residuals^2)
# 离均差平方和
ss0 <- var(data9_1$conc)*(nrow(data9_1)-1)
# 回归平方和
ss1 <- ss0-ss2
# F统计量
f.statistic <- (ss1/1)/(ss2/(nrow(data9_1)-2))
# p值
p <- pf(f.statistic, lower.tail=FALSE, df1=1, df2=nrow(data9_1)-2)
cat("F statistic is ", f.statistic, "\np value is ", p, sep="")
```
* 直接调用查看summary.lm对象里的f值并转为p值
```{r}
f_df1_df2 <- summary(line.model)$fstatistic
p_value <- pf(f_df1_df2[1], df1=f_df1_df2[2], df2=f_df1_df2[3], lower.tail=F)
cat(cat("F statistic is ", f_df1_df2[1], "\np value is ", p_value, sep=""))
```
* 直接打印sammary.lm对象，最后一行信息即为其F值和对应p值
```{r}
summary(lm(conc~age, data=data9_1))
```
#### 1.3.2 t检验
t值计算公式：
\[
  t=\frac{b-0}{S_{b}},\ \nu=n-2
\]

\[
  S_{b}=\frac{S_{Y\cdot X}}{\sqrt{l_{XX}}}
\]

\[
  S_{Y\cdot X}=\sqrt{\frac{SS_{残}}{n-2}}
\]

$S_{Y\cdot X}$为回归的剩余标准差，化简后有：

\[
  \sqrt{F}=t
\]

R语言实现（双侧t检验）：
```{r}
lxx <- var(data9_1$age)*(nrow(data9_1)-1)
Sb <- sqrt(sum(line.model$residuals^2)/(nrow(data9_1)-2))/(sqrt(lxx))
t_statistic <- (line.model$coefficients[2]-0)/Sb
cat("t statistic is ", t_statistic, "\np value is ", 
    2*pt(t_statistic, df=nrow(data9_1)-2, lower.tail=FALSE),
    sep="")
```
#### 1.3.3 区间估计
* 总体回归系数$\beta$的可信区间
表示Y0的**均数**95%的置信区间

结合上述t检验的公式，$\beta$的$1-\alpha$可信区间为：
\[
  b\pm t_{\alpha/2,\ \nu}\cdot S_{b}
\]

* 总体均数$\mu$的可信区间

$\hat{Y0}$会因**样本**（拟合的曲线）而异，其抽样误差大小的标准误：

\[
  S_{\hat{Y_{0}}}=S_{Y\cdot X}\sqrt{\frac{1}{n}+\frac{(X_{0}-\bar{X})^{2}}{\sum{}{}(X-\bar{X})^{2}}}
\]

$\mu_{Y|X0}$的置信区间为：

\[
  \hat{Y_{0}} \pm t_{\alpha/2,\ \nu}\cdot S_{\hat{Y_{0}}}
\]
R语言实现：
```{r}
lxx <- var(data9_1$age)*(nrow(data9_1)-1)
# 剩余标准差
syx <- sqrt(sum(line.model$residuals^2)/(nrow(data9_1)-2))
Sb <- syx/(sqrt(lxx))
t_statistic <- (line.model$coefficients[2]-0)/Sb

Sy01 <- syx*sqrt(1/nrow(data9_1)+
              (data9_1$age-mean(data9_1$age))^2/
              (var(data9_1$age)*nrow(data9_1)-1))

# geom_smooth自动加上了标准偏差即se=TRUE
library(ggplot2)
p <- ggplot(data9_1, aes(age, conc))+
  xlab("age")+ ylab("concentration")+
  geom_point(size=1.5)+
  geom_smooth(method="lm", se=TRUE)+
  theme_classic()
print(p)

p <- p + geom_smooth(aes(x=age, y=Sy01+
                   age*line.model$coefficients[2]+
                   line.model$coefficients[1]), color="red",
              se=FALSE, method="loess")+
  geom_smooth(aes(x=age, y=-Sy01+
                    age*line.model$coefficients[2]+
                    line.model$coefficients[1]), color="red",
              se=FALSE, method="loess")

print(p)
```

* 个体Y值的预测区间
表示**Y0值**的95%置信区间范围
\[
  S_{Y_{0}}=S_{Y\cdot X}\sqrt{1+\frac{1}{n}+\frac{(X_{0}-\bar{X})^{2}}{\sum{}{}(X-\bar{X})^{2}}}
\]


R语言实现：

```{r}
lxx <- var(data9_1$age)*(nrow(data9_1)-1)
# 剩余标准差
syx <- sqrt(sum(line.model$residuals^2)/(nrow(data9_1)-2))
Sb <- syx/(sqrt(lxx))
t_statistic <- (line.model$coefficients[2]-0)/Sb

Sy02 <- syx*sqrt(1+1/nrow(data9_1)+
              (data9_1$age-mean(data9_1$age))^2/
              (var(data9_1$age)*nrow(data9_1)-1))

p + geom_smooth(aes(x=age, y=Sy02+
                   age*line.model$coefficients[2]+
                   line.model$coefficients[1]), color="green",
              se=FALSE, method="loess")+
  geom_smooth(aes(x=age, y=-Sy02+
                    age*line.model$coefficients[2]+
                    line.model$coefficients[1]), color="green",
              se=FALSE, method="loess")+
  geom_vline(xintercept=mean(data9_1$age), lwd=1, color="yellow", linetype=2)+
  annotate("text", x=mean(data9_1$age), y=3.5, label="X_bar")+
  guides(color = guide_legend(title = "LEFT", title.position = "left"))
```
## 2. 直线相关
### 2.1 相关概念
* 又称简单相关，用于双变量正态分布
* 相关系数（coefficient of correlation）又称Pearson积差相关系数（coefficient of product-moment correlation），符号$r$代表样本相关系数，符号$p$代表总体相关系数。

### 2.2 计算公式
以符号$r$表示样本相关系数，符号$\rho$表示总体相关系数，$r$是$rho$的估计，与b不同，它没有单位
\[
  r=\frac{\sum{}{}(X-\bar{X})(Y-\bar{Y})}{\sqrt{\sum{}{}(X-\bar(X))^{2}}\sqrt{\sum{}{}(Y-\bar{Y})^{2}}}=\frac{l_{XY}}{\sqrt{l_{XY}l_{YY}}}
\]

R语言实现：
```{r}
data9_5 <- haven::read_sav(
  file="E:\\医学统计学（第4版）\\各章例题SPSS数据文件\\例09-05.sav")
colnames(data9_5) <- c("number", "age", "v")
# 公式法
r <- sum((data9_5$age-mean(data9_5$age))*(data9_5$v-mean(data9_5$v)))/
  sqrt(var(data9_5$age)*(nrow(data9_5)-1)*var(data9_5$v)*(nrow(data9_5)-1))
print(r)
# 包法
cor(data9_5$age, data9_5$v)
```

### 2.3 统计推断

#### 2.3.1 t检验   
H0：$\rho=0$
\[
  S_{r}=\sqrt{\frac{1-r^{2}}{n-2}},\ \nu=n-2
\]
\[
  t=\frac{r-0}{S_{r}}
\]

R语言实现：
```{r}
# 方法1：
Sr <- sqrt((1-r^2)/(nrow(data9_5)-2))
t_statistic <- (r-0)/Sr
pt(t_statistic, lower.tail=FALSE, df=nrow(data9_5)-2)*2

# 方法2：
cor.test(data9_5$v, data9_5$age)
```

#### 2.3.2 可信区间
由于相关系数的抽样分布在$\rho$不等于0的情况下呈偏态分布，所以不能用t分布直接计算，向进行变量变换，使其服从正态分布在计算可信区间
* 对r作z反双曲正切函数变换：
\[
  z=tanh^{-1}r或z=\frac{1}{2}ln\frac{1+r}{1-r}
\]
* 近似计算z的可信区间
\[(z-u_{\alpha/2/\sqrt{n-3}},\ z+u_{\alpha/2/\sqrt{n-3}})
\]

* 变换z为r
\[
  r=tanhz或r=\frac{e^{2z}-1}{e^{2z}+1}
\]

R语言实现
```{r}
# 方法1：
z <- atanh(r)
u_0.05_2 <- qnorm(0.975, mean=0, sd=1)
r1 <- tanh(z-u_0.05_2/sqrt(nrow(data9_5)-3))
r2 <- tanh(z+u_0.05_2/sqrt(nrow(data9_5)-3))
cat("CL is ", r1, "~", r2, sep="")
# 方法2：
cor.test(data9_5$age, data9_5$v, conf.level=0.95, alternative="two.sided")
```

### 2.4 决定系数
定义：回归平方和与总平方和之比，计算公式为

\[
    R^{2}=\frac{SS_{回}}{SS_{总}}=\frac{l_{XY}^{2}/l_{XX}}{l_{YY}}  
\]
对于双变量回归分析，$R^{2}$即$r^{2}$，处可以概括拟合效果外，还可以作假设检验

\[
    F=\frac{R^{2}}{(1-R^{2})(n-2)}=\frac{SS_{回}}{SS_{残}/\nu_{残}}=\frac{MS_{回}}{MS_{残}}
\]

R语言实现：
```{r}
data9_5 <- haven::read_sav(
  file="E:\\医学统计学（第4版）\\各章例题SPSS数据文件\\例09-05.sav")
colnames(data9_5) <- c("number", "age", "v")
line.model <- lm(v~age, data=data9_5)
r.squared <- summary(line.model)$r.squared
print(r.squared)
adj.r.squared <- summary(line.model)$adj.r.squared
print(adj.r.squared)
r.squared <- 1-var(line.model$residuals)*(nrow(data9_5)-1)/
  (var(data9_5$v)*(nrow(data9_5)-1))
print(r.squared)
f.statistic <- (r.squared)/((1-r.squared)/(nrow(data9_5)-2))
print(f.statistic)
summary(line.model)$fstatistic
```


## 3. 直线回归应用注意事项
* 根据目的选择变量及统计方法（自变量和因变量，如重测信度评价的相关系数，r应达到0.40以上

* 进行相关，回归分析前应绘制散点图，离群值

* 结果解释
    * 相关系数或回归系数的绝对值反映密切程度
    * p值越小越有理由认为变量间的直线关系存在
    
* 残差图观察是否符合模型假设的条件：自变量与因变量关系为线性，误差服从均数为0的正态分布，且方差相等，各观测独立
    * 正常为在y=0处对称分布，并且左右对称
    * 离群值会与群体远离
    * 喇叭状（左右不对称）说明方差不齐（须稳定化处理）
    * 呈曲线则可能是符合曲线模型
    * 呈直线说明残差与时间存在相关
    
* R语言实现残差图
```{r}
data9_5 <- haven::read_sav(
  file="E:\\医学统计学（第4版）\\各章例题SPSS数据文件\\例09-05.sav")
colnames(data9_5) <- c("number", "age", "v")
line.model <- lm(v~age, data=data9_5)
# +geom_point(aes(age, v), size=1.5)+
#   geom_smooth(aes(age, v), method="lm")+
library(ggplot2)
ggplot(data9_5)+
  geom_point(aes(x=age, y=line.model$residuals), color="red", size=2)+
  ylab("residuals")
```
